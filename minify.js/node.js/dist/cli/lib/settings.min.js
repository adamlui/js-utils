/**
 * © 2024–2026 Adam Lui & contributors under the MIT license.
 * Source: https://github.com/adamlui/minify.js/tree/main/node.js/src
 * Documentation: https://github.com/adamlui/minify.js/tree/main/node.js/docs
 */
let fs=require("fs"),log=require(`./log${env.devMode?"":".min"}.js`),path=require("path");(globalThis.cli??={}).config={},module.exports={configFilename:"minify.config.mjs",controls:{dryRun:{type:"flag",regex:/^--?(?:n|dry-?run)$/},includeDotFolders:{type:"flag",regex:/^--?(?:dd?|(?:include-?)?dot-?(?:folder|dir(?:ector(?:y|ie))?)s?=?(?:true|1)?)$/},includeDotFiles:{type:"flag",regex:/^--?(?:df|D|(?:include-?)?dot-?files?=?(?:true|1)?)$/},noRecursion:{type:"flag",regex:/^--?(?:R|(?:disable|no)-?recursi(?:on|ve)|recursi(?:on|ve)=(?:false|0))$/},noMangle:{type:"flag",regex:/^--?(?:M|(?:disable|no)-?mangle|mangle=(?:false|0))$/},noFilenameChange:{type:"flag",regex:/^--?(?:X|(?:disable|no)-?(?:file)?name-?change|(?:file)?name-?change=(?:false|0))$/},rewriteImports:{type:"flag",regex:/^--?(?:i|rewrite-?imports?=?(?:true|1)?)$/},copy:{type:"flag",regex:/^--?c(?:opy)?$/},relativeOutput:{type:"flag",regex:/^--?(?:r|relative-?output?=?(?:true|1)?)$/},quietMode:{type:"flag",regex:/^--?q(?:uiet)?(?:-?mode)?$/},ignores:{type:"param",regex:/^--?(?:ignores?|(?:ignore|skip|exclude)(?:d?-?files?)?)(?:=.*|$)/},comment:{type:"param",regex:/^--?comments?(?:=.*|$)/},config:{type:"param",regex:/^--?config(?:=.*|$)/},init:{type:"cmd",regex:/^-{0,2}init$/},help:{type:"cmd",regex:/^--?h(?:elp)?$/},version:{type:"cmd",regex:/^--?ve?r?s?i?o?n?$/}},async initConfigFile(i=this.configFilename){log.prefix="initConfigFile()";var e=path.resolve(process.cwd(),i);if(fs.existsSync(e))return log.warn(cli.msgs.warn_configFileExists+":",e);var r=path.resolve(__dirname,"../../"+(env.devMode?"../":"./data/")+i);if(fs.existsSync(r))fs.copyFileSync(r,e);else{r=require(`./data${env.devMode?"":".min"}.js`),i=cli.urls.jsdelivr+"/node.js/"+i;log.data(cli.msgs.info_fetchingRemoteConfigFrom+` ${i}...`);try{var o=await r.fetch(i);if(!o.ok)return log.warn(`${cli.msgs.warn_remoteConfigNotFound}: ${i} (${o.status})`);r.atomicWrite(e,await o.text())}catch(e){return log.warn(cli.msgs.warn_remoteConfigFailed+`: ${i} `+e.message)}}log.success(cli.msgs.info_configFileCreated+`: ${e}
`),log.tip(cli.msgs.tip_editToSetDefaults+"."),log.tip(cli.msgs.tip_cliArgsPrioritized+".")},load({args:e=process.argv.slice(2),ctrlKeys:t=Object.keys(this.controls)}={}){log.prefix="settings.load()",t.forEach(e=>{var i=this.controls[e];i.mode||"cmd"==i.type||(cli.config[e]??=i.defaultVal??("flag"!=i.type&&""))});let i;var r=e.find(e=>this.controls.config.regex.test(e));if(r){/=/.test(r)||log.errorAndExit(`[${r}] `+cli.msgs.error_mustIncludePath);r=r.split("=")[1];i=path.isAbsolute(r)?r:path.resolve(process.cwd(),r),fs.existsSync(i)||log.configURLandExit(cli.msgs.error_configFileNotFound+":",i)}else for(var o of["mjs","cjs","js"]){o=path.resolve(process.cwd(),this.configFilename.replace(/\.[^.]+$/,"."+o));if(fs.existsSync(o)){i=o;break}}if(i)try{var s=require(i),l=s?.default??s;l&&"object"==typeof l||log.configURLandExit(cli.msgs.error_invalidConfigFile+"."),Object.assign(cli.config,l)}catch(e){log.configURLandExit(cli.msgs.error_failedToLoadConfigFile+":",i,`
`+e.message)}return e.forEach(i=>{if(!/^[^-]|--?(?:config|debug)/.test(i)){var r=t.find(e=>this.controls[e]?.regex?.test(i)),o=(r||log.errorAndExit(`[${i}] ${cli.msgs.error_notRecognized}.`),this.controls[r]);if("cmd"!=o.type){let e="param"!=o.type||i.split("=")[1]?.trim();o.mode?cli.config.mode=r.replace(/mode$/i,"").toLowerCase():((o=o.parser)&&(e=o(e),isNaN(e)||e<1)&&log.errorAndExit(`[${r}] ${cli.msgs.error_nonPositiveNum}.`),cli.config[r]=e)}}}),cli.config}};