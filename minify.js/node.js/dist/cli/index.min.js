#!/usr/bin/env node
/**
 *  Â© 2023â€“2026 Adam Lui & contributors under the MIT license.
 *  Source: https://github.com/adamlui/minify.js/tree/main/node.js/src
 *  Documentation: https://github.com/adamlui/minify.js/tree/main/node.js/docs
 */
(async()=>{globalThis.env={devMode:__dirname.match(/[\\/]src/)};let o=require("node-clipboardy"),p=require("child_process").execSync,t=require("fs"),{getMsgs:e,getSysLang:s}=require(`./lib/language${env.devMode?"":".min"}.js`),n=require(`../minify${env.devMode?"":".min"}.js`),m=require("path"),i=(globalThis.app=require(`../${env.devMode?"../":"./data/"}app.json`),app.urls.docs+="/#-command-line-usage",app.msgs=await e(s()),app.regex={flags:{dryRun:/^--?(?:n|dry-?run)$/,includeDotFolders:/^--?(?:dd?|(?:include-?)?dot-?(?:folder|dir(?:ector(?:y|ie))?)s?=?(?:true|1)?)$/,includeDotFiles:/^--?(?:df|D|(?:include-?)?dot-?files?=?(?:true|1)?)$/,noRecursion:/^--?(?:R|(?:disable|no)-?recursi(?:on|ve)|recursi(?:on|ve)=(?:false|0))$/,noMangle:/^--?(?:M|(?:disable|no)-?mangle|mangle=(?:false|0))$/,noFilenameChange:/^--?(?:X|(?:disable|no)-?(?:file)?name-?change|(?:file)?name-?change=(?:false|0))$/,rewriteImports:/^--?(?:i|rewrite-?imports?=?(?:true|1)?)$/,relativeOutput:/^--?(?:r|relative-?output?=?(?:true|1)?)$/,copy:/^--?c(?:opy)?$/,quietMode:/^--?q(?:uiet)?(?:-?mode)?$/},paramOptions:{ignores:/^--?(?:ignores?|(?:ignore|skip|exclude)(?:d?-?files?)?)(?:=.*|$)/,comment:/^--?comments?(?:=.*|$)/},infoCmds:{help:/^--?h(?:elp)?$/,version:/^--?ve?r?s?i?o?n?$/},version:/^[~^>=]?\d+\.\d+\.\d+$/},"[0m"),c="[1;91m",g="[1;33m",l="[1;92m",f="[1;97m";if(app.config={},process.argv.forEach(s=>{var e,p,o;s.startsWith("-")&&(e=Object.keys(app.regex.paramOptions).find(e=>app.regex.paramOptions[e].test(s)),o=Object.keys(app.regex.flags).find(e=>app.regex.flags[e].test(s)),p=Object.keys(app.regex.infoCmds).find(e=>app.regex.infoCmds[e].test(s)),o?app.config[o]=!0:e?(/=.+/.test(s)||(console.error(`
${c}${app.msgs.prefix_error}: Arg [--${s.replace(/-/g,"")}] ${app.msgs.error_noEqual}.[0m`),u(),process.exit(1)),o=s.split("=")[1],app.config[e]=parseInt(o)||o):p||(console.error(`
${c}${app.msgs.prefix_error}: Arg [${s}] ${app.msgs.error_notRecognized}.[0m`),console.info(`
${g}${app.msgs.info_validArgs}.[0m`),r(["paramOptions","flags","infoCmds"]),process.exit(1)))}),process.argv.some(e=>app.regex.infoCmds.help.test(e)))r();else if(process.argv.some(e=>app.regex.infoCmds.version.test(e))){var d=p(`npm view ${JSON.stringify(app.name)} version`).toString().trim()||"none";let e,s=process.cwd();for(;"/"!=s;){var a=m.join(s,"package.json");if(t.existsSync(a)){a=require(a);e=(a.dependencies?.[app.name]||a.devDependencies?.[app.name])?.match(/^[~^>=]?\d+\.\d+\.\d+$/)?.[1]||"none";break}s=m.dirname(s)}console.info(`
${app.msgs.prefix_globalVer}: `+d),console.info(app.msgs.prefix_localVer+": "+e)}else{let[a="",r=""]=process.argv.slice(2).filter(e=>!e.startsWith("-")).map(e=>e.replace(/^\/*/,"")),s=m.resolve(process.cwd(),a);a&&!t.existsSync(s)&&(d=s+".js",t.existsSync(d)?s=d:(console.error(`
${c}${app.msgs.prefix_error}: `+app.msgs.error_firstArgNotExist+"."+`
${s} ${app.msgs.error_doesNotExist}.[0m`),console.info(`
${l}${app.msgs.info_exampleValidCmd}: `+`
Â» minify-js . output.min.js[0m`),u(),process.exit(1)));var $,d=s.endsWith(".js")&&!t.statSync(s).isDirectory()?[s]:n.findJS(s,{recursive:!app.config.noRecursion,verbose:!app.config.quietMode,ignores:(app.config.ignores?.split(",")??[]).map(e=>e.trim())});if(app.config.dryRun)d.length?(console.info(`
${g}${app.msgs.info_filesToBeMinned}:[0m`),d.forEach(e=>console.info(e))):console.info(`
${g}${app.msgs.info_noFilesWillBeMinned}.[0m`);else{let p=[],e=[];!app.config.relativeOutput&&t.statSync(s).isDirectory()?($=n.minify(s,{verbose:!1,mangle:!app.config.noMangle,comment:app.config.comment?.replace(/\\n/g,"\n"),relativeOutput:!1,recursive:!app.config.noRecursion,dotFolders:!!app.config.includeDotFolders,dotFiles:!!app.config.includeDotFiles,rewriteImports:!!app.config.rewriteImports,ignores:app.config.ignores?app.config.ignores.split(",").map(e=>e.trim()):[]}))&&($.error?p.push(s):e=[].concat($)):e=d.map(e=>{var s=n.minify(e,{verbose:!app.config.quietMode,mangle:!app.config.noMangle,comment:app.config.comment?.replace(/\\n/g,"\n")});return s.error&&p.push(e),s}).filter(e=>!e.error),e?.length?(h(`
${l}${app.msgs.info_minComplete}![0m`),h(f+e.length+" "+app.msgs.info_file+`${1<e.length?"s":""} ${app.msgs.info_minified}.${i}`)):h(`
${g}${app.msgs.info_noFilesProcessed}.[0m`),p.length&&(h(`
${c}${p.length} `+app.msgs.info_file+`${1<p.length?"s":""} ${app.msgs.info_failedToMinify}:${i}`),p.forEach(e=>h(e))),e?.length&&(app.config.copy&&1==e?.length?(console.log(`
${f}${e[0].code}[0m`),h(`
${app.msgs.info_copying}...`),o.writeSync(e[0].code)):(h(`
${app.msgs.info_writing}${1<e?.length?"s":""}...`),e?.forEach(({code:e,srcPath:p,relPath:o})=>{let n,i;if(!app.config.relativeOutput&&o){let e=m.resolve(process.cwd(),r||"min"),s=m.dirname(o);n="."!=s?m.join(e,s):e,i=m.basename(p,".js")+`${app.config.noFilenameChange?"":".min"}.js`}else n=m.join(m.dirname(p),r.endsWith(".js")?m.dirname(r):r||"min"),i=`${r.endsWith(".js")&&a.endsWith(".js")?m.basename(r).replace(/(\.min)?\.js$/,""):m.basename(p,".js")}${app.config.noFilenameChange?"":".min"}.js`;let s=m.join(n,i);t.existsSync(n)||t.mkdirSync(n,{recursive:!0}),t.writeFileSync(s,e,"utf8"),h(`  ${l}âœ“[0m `+m.relative(process.cwd(),s))})))}}function u(){console.info(`
${app.msgs.info_moreHelp}, ${app.msgs.info_type} ${app.name.split("/")[1]} --help' ${app.msgs.info_or} ${app.msgs.info_visit}
${f}${app.urls.docs}[0m`)}function r(e=["header","usage","pathArgs","flags","paramOptions","infoCmds"]){app.prefix=`[106m[30m ${app.name.replace(/^@[^/]+\//,"")} [0m `;let s={header:[`
â”œ ${app.prefix}${app.msgs.appCopyright||`Â© ${app.copyrightYear} ${app.author} under the ${app.license} license`}.`,""+app.prefix+app.msgs.prefix_source+": "+app.urls.src],usage:[`
${f}o ${app.msgs.helpSection_usage}:[0m`,` ${f}Â» ${l}${app.cmdFormat}[0m`],pathArgs:[`
${f}o ${app.msgs.helpSection_pathArgs}:[0m`," [inputPath]                         "+app.msgs.inputPathDesc_main+", "+app.msgs.inputPathDesc_extra+"."," [outputPath]                        "+app.msgs.outputPathDesc_main+", "+app.msgs.outputPathDesc_extra+"."],flags:[`
${f}o ${app.msgs.helpSection_flags}:[0m`,` -n, --dry-run                       ${app.msgs.optionDesc_dryRun}.`,` -d, --include-dotfolders            ${app.msgs.optionDesc_dotfolders}.`,` -D, --include-dotfiles              ${app.msgs.optionDesc_dotfiles}.`,` -R, --no-recursion                  ${app.msgs.optionDesc_noRecursion}.`,` -M, --no-mangle                     ${app.msgs.optionDesc_noMangle}.`," -X, --no-filename-change            "+app.msgs.optionDesc_noFilenameChange,` -i, --rewrite-imports               ${app.msgs.optionDesc_rewriteImports}.`,` -c, --copy                          ${app.msgs.optionDesc_copy}.`,` -r, --relative-output               ${app.msgs.optionDesc_relativeOutput}.`,` -q, --quiet                         ${app.msgs.optionDesc_quiet}.`],paramOptions:[`
${f}o ${app.msgs.helpSection_paramOptions}:[0m`,`--ignores="dir/,file1.js,file2.js"   ${app.msgs.optionDesc_ignores}.`,`--comment="comment"                  ${app.msgs.optionDesc_commentMain}.`+` ${app.msgs.optionDesc_commentExtra}.`],infoCmds:[`
${f}o ${app.msgs.helpSection_infoCmds}:[0m`," -h, --help                          "+app.msgs.optionDesc_help,` -v, --version                       ${app.msgs.optionDesc_version}.`]};e.forEach(a=>s[a]?.forEach(s=>{{var i=/header|usage/.test(a)?1:37;let p=process.stdout.columns||80,o=[],e=s.match(/\S+|\s+/g),n="";e.forEach(e=>{var s=p-(o.length?i:0);n.length+"| ".length+e.length>s&&(o.push(o.length?n.trimStart():n),n=""),n+=e}),o.push(o.length?n.trimStart():n),o.forEach((e,s)=>console.info("| "+(0==s?e:" ".repeat(i)+e)))}})),console.info(`
${app.msgs.info_moreHelp}, ${app.msgs.info_visit}: ${f}${app.urls.docs}[0m`)}function h(e){app.config.quietMode||console.info(e)}})();