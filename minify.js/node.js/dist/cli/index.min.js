#!/usr/bin/env node
/**
 *  Â© 2023â€“2026 Adam Lui & contributors under the MIT license.
 *  Source: https://github.com/adamlui/minify.js/tree/main/node.js/src
 *  Documentation: https://github.com/adamlui/minify.js/tree/main/node.js/docs
 */
(async()=>{globalThis.env={devMode:__dirname.match(/[\\/]src/)};let i=require("node-clipboardy"),c=require("fs"),{getMsgs:e,getSysLang:o}=require(`./lib/language${env.devMode?"":".min"}.js`),p=require(`../minify${env.devMode?"":".min"}.js`),t=require("path"),l=require(`./lib/print${env.devMode?"":".min"}.js`);if(Object.assign(globalThis.app??={},require(`../${env.devMode?"../":"./data/"}app.json`)),app.urls.docs+="/#-command-line-usage",app.msgs=await e(o()),app.colors={nc:"[0m",br:"[1;91m",by:"[1;33m",bg:"[1;92m",bw:"[1;97m",blk:"[30m",tlBG:"[106m"},app.regex={flags:{dryRun:/^--?(?:n|dry-?run)$/,includeDotFolders:/^--?(?:dd?|(?:include-?)?dot-?(?:folder|dir(?:ector(?:y|ie))?)s?=?(?:true|1)?)$/,includeDotFiles:/^--?(?:df|D|(?:include-?)?dot-?files?=?(?:true|1)?)$/,noRecursion:/^--?(?:R|(?:disable|no)-?recursi(?:on|ve)|recursi(?:on|ve)=(?:false|0))$/,noMangle:/^--?(?:M|(?:disable|no)-?mangle|mangle=(?:false|0))$/,noFilenameChange:/^--?(?:X|(?:disable|no)-?(?:file)?name-?change|(?:file)?name-?change=(?:false|0))$/,rewriteImports:/^--?(?:i|rewrite-?imports?=?(?:true|1)?)$/,relativeOutput:/^--?(?:r|relative-?output?=?(?:true|1)?)$/,copy:/^--?c(?:opy)?$/,quietMode:/^--?q(?:uiet)?(?:-?mode)?$/},paramOptions:{ignores:/^--?(?:ignores?|(?:ignore|skip|exclude)(?:d?-?files?)?)(?:=.*|$)/,comment:/^--?comments?(?:=.*|$)/},infoCmds:{help:/^--?h(?:elp)?$/,version:/^--?ve?r?s?i?o?n?$/},version:/^[~^>=]?\d+\.\d+\.\d+$/},app.config={},process.argv.forEach(o=>{var e,s,i;o.startsWith("-")&&(e=Object.keys(app.regex.paramOptions).find(e=>app.regex.paramOptions[e].test(o)),i=Object.keys(app.regex.flags).find(e=>app.regex.flags[e].test(o)),s=Object.keys(app.regex.infoCmds).find(e=>app.regex.infoCmds[e].test(o)),i?app.config[i]=!0:e?(/=.+/.test(o)||(console.error(`
${app.colors.br}${app.msgs.prefix_error}: Arg [--${o.replace(/-/g,"")}] ${app.msgs.error_noEqual}.`+app.colors.nc),l.helpCmdAndDocURL(),process.exit(1)),i=o.split("=")[1],app.config[e]=parseInt(i)||i):s||(console.error(`
${app.colors.br}${app.msgs.prefix_error}: Arg [${o}] ${app.msgs.error_notRecognized}.`+app.colors.nc),console.info(`
${app.colors.by}${app.msgs.info_validArgs}.`+app.colors.nc),l.help(["paramOptions","flags","infoCmds"]),process.exit(1)))}),process.argv.some(e=>app.regex.infoCmds.help.test(e)))l.help();else if(process.argv.some(e=>app.regex.infoCmds.version.test(e)))l.version();else{let[n="",a=""]=process.argv.slice(2).filter(e=>!e.startsWith("-")).map(e=>e.replace(/^\/*/,"")),o=t.resolve(process.cwd(),n);n&&!c.existsSync(o)&&(g=o+".js",c.existsSync(g)?o=g:(console.error(`
${app.colors.br}${app.msgs.prefix_error}: `+app.msgs.error_firstArgNotExist+"."+`
${o} ${app.msgs.error_doesNotExist}.`+app.colors.nc),console.info(`
${app.colors.bg}${app.msgs.info_exampleValidCmd}: `+`
Â» minify-js . output.min.js`+app.colors.nc),l.helpCmdAndDocURL(),process.exit(1)));var r,g=o.endsWith(".js")&&!c.statSync(o).isDirectory()?[o]:p.findJS(o,{recursive:!app.config.noRecursion,verbose:!app.config.quietMode,ignores:(app.config.ignores?.split(",")??[]).map(e=>e.trim())});if(app.config.dryRun)g.length?(console.info(`
${app.colors.by}${app.msgs.info_filesToBeMinned}:`+app.colors.nc),g.forEach(e=>console.info(e))):console.info(`
${app.colors.by}${app.msgs.info_noFilesWillBeMinned}.`+app.colors.nc);else{let s=[],e=[];!app.config.relativeOutput&&c.statSync(o).isDirectory()?(r=p.minify(o,{verbose:!1,mangle:!app.config.noMangle,comment:app.config.comment?.replace(/\\n/g,"\n"),relativeOutput:!1,recursive:!app.config.noRecursion,dotFolders:!!app.config.includeDotFolders,dotFiles:!!app.config.includeDotFiles,rewriteImports:!!app.config.rewriteImports,ignores:app.config.ignores?app.config.ignores.split(",").map(e=>e.trim()):[]}))&&(r.error?s.push(o):e=[].concat(r)):e=g.map(e=>{var o=p.minify(e,{verbose:!app.config.quietMode,mangle:!app.config.noMangle,comment:app.config.comment?.replace(/\\n/g,"\n")});return o.error&&s.push(e),o}).filter(e=>!e.error),e?.length?(l.ifNotQuiet(`
${app.colors.bg}${app.msgs.info_minComplete}!`+app.colors.nc),l.ifNotQuiet(""+app.colors.bw+e.length+" "+app.msgs.info_file+`${1<e.length?"s":""} ${app.msgs.info_minified}.`+app.colors.nc)):l.ifNotQuiet(`
${app.colors.by}${app.msgs.info_noFilesProcessed}.`+app.colors.nc),s.length&&(l.ifNotQuiet(`
${app.colors.br}${s.length} `+app.msgs.info_file+`${1<s.length?"s":""} ${app.msgs.info_failedToMinify}:`+app.colors.nc),s.forEach(e=>l.ifNotQuiet(e))),e?.length&&(app.config.copy&&1==e?.length?(console.log(`
`+app.colors.bw+e[0].code+app.colors.nc),l.ifNotQuiet(`
${app.msgs.info_copying}...`),i.writeSync(e[0].code)):(l.ifNotQuiet(`
${app.msgs.info_writing}${1<e?.length?"s":""}...`),e?.forEach(({code:e,srcPath:s,relPath:i})=>{let p,r;if(!app.config.relativeOutput&&i){let e=t.resolve(process.cwd(),a||"min"),o=t.dirname(i);p="."!=o?t.join(e,o):e,r=t.basename(s,".js")+`${app.config.noFilenameChange?"":".min"}.js`}else p=t.join(t.dirname(s),a.endsWith(".js")?t.dirname(a):a||"min"),r=`${a.endsWith(".js")&&n.endsWith(".js")?t.basename(a).replace(/(\.min)?\.js$/,""):t.basename(s,".js")}${app.config.noFilenameChange?"":".min"}.js`;let o=t.join(p,r);c.existsSync(p)||c.mkdirSync(p,{recursive:!0}),c.writeFileSync(o,e,"utf8"),l.ifNotQuiet(`  ${app.colors.bg}âœ“${app.colors.nc} `+t.relative(process.cwd(),o))})))}}})();