name: Sync minify.js + scss-to-css releases to adamlui/<app-repo>

on:
  release:
    types: [published, edited, released]

jobs:
  sync-release:
    name: Sync release to adamlui/<app-repo>
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      REPO_SYNC_PAT: ${{ secrets.REPO_SYNC_PAT }}
    steps:
      - name: Sync release to adamlui/<app-repo>
        run: |
          # Get release title/tag/notes from event
          RELEASE_TITLE="${{ github.event.release.name }}"
          release_tag_name="${{ github.event.release.tag_name }}"

          # Get fresh release data from API
          this_release=$(curl -s https://api.github.com/repos/adamlui/js-utils/releases/tags/$release_tag_name)
          RELEASE_NOTES=$(echo "$this_release" | sed -nE 's/.*"body": "(.*)".*/\1/p')
          release_app_name=$(echo "$RELEASE_TITLE" | sed -E 's|^ *|| ; s| [(v].*||')

          if [[ "$RELEASE_NOTES" == *"Auto-synced from"* ]] ; then
              echo "Release already auto-synced. Exiting..." ; exit 0 ; fi

          # Process notes
          RELEASE_NOTES=$(echo "$RELEASE_NOTES" | \
            sed 's|ðŸ“ƒ|:page_with_curl:|g; s|ðŸš€|:rocket:|g; s|ðŸ§ |:brain:|g' | \
            sed -E "s|js-utils(/compare/)(.+)-([^-]+)-([0-9.]+)\.\.\.([^0-9]+)|\2\1\3-v\4...\3-v|g" | \
            sed -E "s|js-utils(/tree/)(.+)-([^-]+)-([0-9.]+)/[^/]+/(.*)|\2\1\3-v\4/\5|g")

          echo "Release Title: $RELEASE_TITLE"
          echo "Release Tag: $release_tag_name"
          echo "Processing for app: $release_app_name"

          # Check for multi-repo existence
          app_repos=("minify.js" "scss-to-css")
          for repo in "${app_repos[@]}" ; do
            if [[ "$release_tag_name" == "$repo"* ]] ; then repo_exists=true ; break ; fi ; done
          if [ ! -v repo_exists ] ; then
            echo "No multi-repo for $release_app_name exists. Exiting..." ; exit 0 ; fi

          # Check for release existence in target repo
          re_app_repos=$(printf '%s|' "${app_repos[@]}" | sed 's/\./\\./g' | sed 's/|$//')
          TARGET_RELEASE_TAG_NAME=$(echo "$release_tag_name" | sed -E '
            # minify.js-<gulp|node>-<ver> -> <gulp|node>-v<ver>
            s#^(minify\.js)-(node|gulp)-v?([0-9.]+)$#\2-v\3#;
            # scss-to-css-<ver> -> v<ver>
            s#^v?([0-9.]+)$#scss-to-css-\1#
          ')
          release_check_resp=$(curl -s -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/adamlui/$release_app_name/releases/tags/$TARGET_RELEASE_TAG_NAME)
          if echo "$release_check_resp" | grep -q '"id"'; then
            RELEASE_EXISTS=true
            TARGET_RELEASE_ID=$(echo "$release_check_resp" | grep -o '"id":[[:space:]]*[0-9]\+' | head -1 | grep -o '[0-9]\+')
            echo "Release exists @ adamlui/$release_app_name (ID: $TARGET_RELEASE_ID). Will update..."
          else
            RELEASE_EXISTS=false
            echo "Release doesn't exist. Will create..."
          fi

          # Download assets
          download_urls=$(echo "$this_release" | grep -o '"browser_download_url": ".*"' | cut -d '"' -f 4)
          for url in $download_urls; do
            echo -e "Downloading $(basename "$url")..."
            curl -LOs "$url"
          done

          # Publish new or update existing release
          echo "Publishing release..."
          RELEASE_NOTES+="\n\n###### _Auto-synced from https://github.com/adamlui/js-utils/releases"
          RELEASE_NOTES+=" by_ :robot: [kudo-sync-bot](https://github.com/kudo-sync-bot)"

          if [ "$RELEASE_EXISTS" = false ] ; then
            # CREATE new release
            echo "Creating new release..."
            create_release_url="https://api.github.com/repos/adamlui/$release_app_name/releases"
            create_release_payload=$(
              printf '{"tag_name": "%s","name": "%s","body": "%s"}' \
                "$TARGET_RELEASE_TAG_NAME" "$RELEASE_TITLE" "$RELEASE_NOTES")
            create_release_response=$(
              curl -s -S -X POST -H "Authorization: token $REPO_SYNC_PAT" \
                   -H "Content-Type: application/json" -d "$create_release_payload" "$create_release_url")
            upload_url=$(echo "$create_release_response" | sed -nE 's|.*"upload_url": "(.*)".*|\1|p' | sed 's|{.*}||')
          else
            # UPDATE existing release
            echo "Updating existing release..."
            update_release_url="https://api.github.com/repos/adamlui/$release_app_name/releases/$TARGET_RELEASE_ID"
            update_release_payload=$(
              printf '{"name": "%s","body": "%s"}' \
                "$RELEASE_TITLE" "$RELEASE_NOTES")
            patch_response=$(curl -s -S -X PATCH -H "Authorization: token $REPO_SYNC_PAT" \
                 -H "Content-Type: application/json" -d "$update_release_payload" "$update_release_url")
            if echo "$patch_response" | grep -q '"message"'; then
                echo "ERROR: Failed to update release: $patch_response"
                exit 1
            fi
            release_get_response=$(curl -s -S -H "Authorization: token $REPO_SYNC_PAT" \
              "https://api.github.com/repos/adamlui/$release_app_name/releases/tags/$TARGET_RELEASE_TAG_NAME")
            upload_url=$(echo "$release_get_response" | sed -nE 's|.*"upload_url": "(.*)".*|\1|p' | sed 's|{.*}||')
          fi

          # Upload assets to release
          echo "Uploading assets to release..."
          if [ -z "$upload_url" ]; then
            echo "ERROR: Could not get upload URL. Skipping asset upload."
          else
            for url in $download_urls ; do
              filename=$(basename "$url")
              echo "Uploading $filename..."
              curl -s -S --data-binary @"$filename" \
                   -H "Authorization: token $REPO_SYNC_PAT" \
                   -H "Content-Type: application/octet-stream" \
                   "$upload_url?name=$filename" \
                     > /dev/null 2>&1 # hide verbosity
            done
          fi

          echo "Release duplicated to adamlui/$release_app_name tagged $TARGET_RELEASE_TAG_NAME"
